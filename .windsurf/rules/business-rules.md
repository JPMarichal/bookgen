---
trigger: always_on
---

# BookGen Business Rules

## Overview

Core business rules and constraints for the BookGen automated biography generation system. These rules are codified in the application and must be maintained.

## Biography Generation Rules

### Directory Structure Requirements

**Per-Character Directory:**
Each biography must have its own directory under `bios/{character_name}/`:

```
bios/{character_name}/
├── research/              # REQUIRED: Research materials
│   ├── fuentes.md        # Source bibliography
│   └── plan-de-trabajo.md # Work plan with chapter outline
├── chapters/             # REQUIRED: Chapter content
│   ├── capitulo-01.md through capitulo-20.md (exactly 20)
├── sections/             # REQUIRED: Special sections
│   ├── prologo.md
│   ├── introduccion.md
│   ├── cronologia.md
│   ├── epilogo.md
│   ├── glosario.md
│   ├── dramatis-personae.md
│   └── fuentes.md
├── output/               # Generated by system
│   ├── markdown/         # Concatenated files
│   ├── word/            # Word exports
│   └── kdp/             # KDP metadata
└── control/              # Optional: Quality logs
    └── longitudes.csv
```

**Enforced by:** `src/config/export_config.py`, `src/services/concatenation.py`

### Content Requirements

**Chapter Structure:**
- Exactly 20 chapters (configurable via `CHAPTERS_NUMBER` in .env)
- Each chapter starts with `# Capítulo N: [título]`
- Chapters use hierarchical headings: `#`, `##`, `###` (max 3 levels)

**Word Count Targets:**
- Total biography: Minimum 51,000 words (configurable via `TOTAL_WORDS`)
- Per chapter: ~2,550 words average (configurable via `WORDS_PER_CHAPTER`)
- Tolerance: ±5% acceptable variance

**Enforced by:** `src/services/length_validator.py`

**Section Order (Fixed):**
1. Prólogo
2. Introducción metodológica
3. Cronología
4. Capítulos 1-20
5. Epílogo analítico
6. Glosario
7. Dramatis personae
8. Fuentes bibliográficas

**Enforced by:** `src/services/concatenation.py` (FILE_ORDER constant)

### Source Requirements

**Source Quality:**
- Minimum 40-60 sources per biography
- Mix of primary, secondary, and tertiary sources
- All URLs must be valid and accessible (HTTP 200)
- Academic citation format (APA or Chicago)

**Enforced by:** `src/services/source_validator.py`, `src/tasks/validation_tasks.py`

### Export Requirements

**Word Document:**
- Template: `wordTemplate/reference.docx`
- Output path: `bios/{character}/output/word/La biografia de {Character}.docx`
- Format: Pandoc conversion with reference template

**Enforced by:** `src/services/word_exporter.py`

**ZIP Export:**
- Includes: markdown, Word, and KDP files
- Output: Temporary file, cleaned up after download
- Filename: `{character}_biography_output.zip`

**Enforced by:** `src/services/zip_export_service.py`

## Generation Strategies

### Strategy Types

**1. Automatic Strategy:**
- Fully automated source discovery
- AI generates sources from general knowledge
- Fastest generation time
- Lower source verification

**Location:** `src/strategies/automatic.py`

**2. Hybrid Strategy:**
- User provides initial sources
- AI validates and expands source list
- Balanced speed and quality
- Recommended for most biographies

**Location:** `src/strategies/hybrid.py`

**3. Personalized Strategy:**
- Custom strategy per character
- Manual source curation
- Highest quality control
- Slowest generation

**Location:** `src/strategies/personalized.py`

### State Machine Phases

Biography generation follows these phases in order:

1. **INITIALIZATION** - Validate inputs, setup directories
2. **SOURCE_GENERATION** - Gather/validate sources
3. **PLANNING** - Create work plan and chapter outline
4. **CONTENT_GENERATION** - Generate all chapters
5. **VALIDATION** - Validate length, quality, coherence
6. **EXPORT** - Concatenate, export to Word/ZIP
7. **COMPLETION** - Finalize, send notifications

**Enforced by:** `src/engine/biography_engine.py`

## Data Management Rules

### File Storage

**Generated Content:**
- Biography content: `bios/{character}/` subdirectories
- Never in root directory
- Structured by character name
- Output in `output/` subdirectories

**Temporary Files:**
- Created in `/tmp` or system temp directory
- Cleaned up after use (e.g., ZIP files after download)
- Never committed to git

**Configuration:**
- Environment variables in `.env` (gitignored)
- Example config in `.env.production.example`
- No secrets in code or committed files

### Database

**Models:**
- Characters, Sources, Chapters defined in `src/models/`
- Migrations in `alembic/versions/`
- SQLite for development, PostgreSQL for production

**Migration Rules:**
- Always create migration for schema changes
- Test migrations before committing
- Don't modify existing migrations
- Use `alembic revision --autogenerate`

## API Design Rules

### Endpoint Patterns

**RESTful Conventions:**
```
GET    /biographies              # List all biographies
POST   /biographies              # Start new biography generation
GET    /biographies/{character}  # Get biography status
DELETE /biographies/{character}  # Cancel/delete biography
GET    /biographies/{character}/download-output  # Download ZIP
```

**Enforced by:** `src/api/routers/biographies.py`

### Response Formats

**Success Response:**
```json
{
  "success": true,
  "data": { ... },
  "message": "Optional message"
}
```

**Error Response:**
```json
{
  "detail": "Error message",
  "error_code": "SPECIFIC_ERROR_CODE"
}
```

**Progress Updates (WebSocket):**
```json
{
  "phase": "CONTENT_GENERATION",
  "progress": 0.65,
  "message": "Generating chapter 13/20",
  "chapter": 13
}
```

### Rate Limiting

- Default: 100 requests per minute per IP
- Configurable via middleware
- Applied to all API endpoints except health check

**Enforced by:** `src/api/middleware/rate_limiter.py`

## Notification Rules

### Notification Channels

**WebSocket (Real-time):**
- Phase changes
- Progress updates
- Error notifications
- Used for UI live updates

**Webhook (Async):**
- Generation started
- Generation completed
- Generation failed
- Configured via API

**Email (Async):**
- Generation completed successfully
- Generation failed with errors
- Configurable per user

**Enforced by:** `src/services/notifications.py`

## Quality Assurance Rules

### Validation Checks

**Pre-Generation:**
- Character name is valid and normalized
- Strategy is valid (automatic/hybrid/personalized)
- Required directories can be created
- Template files exist

**During Generation:**
- Source URLs are accessible
- Content meets length requirements
- No duplicate content
- Proper markdown formatting

**Post-Generation:**
- All required files exist
- Total word count meets minimum
- All chapters present
- Export files generated successfully

**Enforced by:** Various services in `src/services/`

### Error Handling

**Retry Policy:**
- API errors: Retry up to 3 times with exponential backoff
- Source validation: Retry failed URLs once
- Generation failures: No automatic retry (user intervention)

**Fallback Behavior:**
- Missing optional files: Continue with warning
- Missing required files: Fail immediately
- API rate limits: Wait and retry
- Network errors: Retry with backoff

## Performance Rules

### Concurrency

**Celery Workers:**
- Default: 2 concurrent generations (configurable)
- CPU-intensive tasks use dedicated workers
- I/O tasks (API calls) use separate pool

**Rate Limiting:**
- OpenRouter API: Respect rate limits
- Source validation: Batch requests
- Parallel chapter generation: Max 3 at a time

### Caching

**Source Validation:**
- Cache valid URLs for 24 hours
- Cache failed URLs for 1 hour
- Clear cache on new validation request

**Content Generation:**
- No caching (always fresh generation)
- Cache API responses for retry scenarios

**Enforced by:** `src/cache/`, `src/services/`

## Monitoring Rules

### Metrics Collection

**Application Metrics:**
- Generation success/failure rate
- Average generation time per phase
- API response times
- Error rates by type

**Business Metrics:**
- Biographies completed per day
- Average word count
- Source validation success rate
- Export format distribution

**Exposed via:** `src/api/routers/metrics.py`

### Logging

**Log Levels:**
- DEBUG: Development only, verbose output
- INFO: Normal operations, phase transitions
- WARNING: Recoverable errors, retries
- ERROR: Failures requiring attention
- CRITICAL: System-level failures

**Log Output:**
- Development: Console
- Production: File + external service (configurable)
- Structured logging with context

**Enforced by:** `src/config/logging_config.py`

## Security Rules

### Input Validation

**Character Names:**
- Alphanumeric and basic punctuation only
- Maximum length: 100 characters
- Normalized to lowercase with underscores
- No path traversal characters

**File Paths:**
- Never accept user-provided full paths
- Always construct paths from validated components
- Check for path traversal attempts
- Validate file extensions

### API Security

**Authentication:**
- API key required for production
- Configurable via environment variables
- Rate limiting per authenticated client

**CORS:**
- Configurable allowed origins
- Default: localhost only in development
- Production: Explicit whitelist

**Enforced by:** `src/api/middleware/`, FastAPI security

## Deployment Rules

### Environment Configuration

**Required Environment Variables:**
```bash
OPENROUTER_API_KEY=required     # LLM API access
OPENROUTER_MODEL=required       # Model to use
DATABASE_URL=optional           # Defaults to SQLite
REDIS_URL=optional             # Defaults to localhost
```

**Optional Variables:**
```bash
CHAPTERS_NUMBER=20             # Number of chapters
TOTAL_WORDS=51000             # Minimum word count
WORDS_PER_CHAPTER=2550        # Target per chapter
MAX_CONCURRENT_GENERATIONS=2  # Worker concurrency
LOG_LEVEL=INFO                # Logging verbosity
```

### Docker Deployment

**Development:**
```bash
docker-compose up
```

**Production:**
```bash
docker-compose -f docker-compose.prod.yml up -d
```

**Health Checks:**
- Endpoint: `GET /health`
- Returns: Server status and dependencies

## Migration Rules

### Database Migrations

**Creating Migrations:**
```bash
alembic revision --autogenerate -m "Description"
```

**Applying Migrations:**
```bash
alembic upgrade head
```

**Rules:**
- Always test migrations locally first
- Never modify existing migrations
- Migrations must be idempotent
- Always have rollback plan

### Directory Structure Migrations

**Reference:** See `docs/technical/components/DIRECTORY_MIGRATION.md`

**Key Points:**
- Use migration scripts in `development/scripts/`
- Create backups before migration
- Validate structure after migration
- Update code references

## Deprecated Features

### Manual Scripts (Legacy)

**Archived in:** `development/scripts/legacy/`

- `concat.py` - Replaced by `ConcatenationService`
- `check_lengths.py` - Replaced by `LengthValidator`
- `spine_width.py` - Integrated into export service

**Do not use these scripts** - Use the API instead

### Old Directory Structure

**Deprecated:**
- `esquemas/` → Use `bios/{character}/research/`
- `docx/` → Use `bios/{character}/output/word/`
- Root-level chapter files → Use `bios/{character}/chapters/`

**Migration complete:** See DIRECTORY_MIGRATION.md

## Related Documentation

- [Development Rules](development.md) - Code and project organization
- [System Architecture](../../docs/architecture/system-overview.md)
- [API Documentation](../../docs/api/overview.md)
- [Directory Migration](../../docs/technical/components/DIRECTORY_MIGRATION.md)
- [Legacy Rules Archive](../../docs/archive/windsurf-legacy/README.md)
